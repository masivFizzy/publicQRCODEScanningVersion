<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASIV Intranet</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
</head>

<body>
    <header>
        <div class="header-container">
            <div class="logo">
                <img src="mercedes-and-singh-15-2.png" alt="Logo">
            </div>
            <div class="title">MASIV Intranet</div>
            <button class="login-btn">Login</button>
        </div>
    </header>
    <div id="tools-container">
        <h2>Authentication Code</h2>
        <div>
            <span style="color:rgb(135, 135, 13)">Please click the login button above and get a verification code in
                order to continue</span>
            <input type="text" id="authCode" placeholder="Dropbox Authentication Code" required />
            <button class="button" id="verify">Authenticate</button>
            <p id="feedback" style="text-align: center; margin-top: 20px; color: red;"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check token expiry
            const tokenExpiryDate = localStorage.getItem('token_expiry_date');
            if (tokenExpiryDate) {
                const expiryTime = new Date(tokenExpiryDate).getTime();
                const currentTime = new Date().getTime();
                if (currentTime > expiryTime) {
                    // Clear local storage if the token is expired
                    localStorage.clear();
                    document.getElementById('feedback').textContent = 'Your session has expired. Please log in again.';
                    window.location.href = 'index.html';
                }
            }
        });
        document.querySelector('.login-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('https://masivintranet.onrender.com/authflow');
                if (response.ok) {
                    const data = await response.text();  // Assuming the response is just a URL
                    window.open(data, '_blank');  // Open the URL in a new tab
                } else {
                    console.error('Error fetching authorization URL');
                    document.getElementById('feedback').textContent = 'Failed to fetch the authorization URL.';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('feedback').textContent = 'An error occurred while fetching the authorization URL.';
            }
        });

        document.getElementById('verify').addEventListener('click', async () => {
            const verifyCode = document.getElementById('authCode').value;
            if (!verifyCode) {
                document.getElementById('feedback').textContent = 'Please fill out all required fields.';
                return;
            }

            const verifyData = {
                verify_code: verifyCode,
            }
            try {
                const response = await fetch('https://masivintranet.onrender.com/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(verifyData)
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('feedback').textContent = result.message || 'Verification Accepted you are being rerouted';
                    // Store each item in localStorage
                    localStorage.setItem('access_token', result.access_token);
                    localStorage.setItem('token_expiry_date', result.token_expiry_date);
                    localStorage.setItem('refresh_token', result.refresh_token);
                    localStorage.setItem('verification_message', result.message);
                    console.log(response)
                    console.log('Redirecting to landing.html');
                    window.location.href = 'landing.html';

                } else {
                    const errorData = await response.json();
                    document.getElementById('feedback').textContent = errorData.error || 'Failed to verify.';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('feedback').textContent = 'An error occurred while adding the customer.';
            }
        });
    </script>
</body>

</html>